<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiPo Pack Charging Groups</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }
        .logo-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            padding-bottom: 20px;
            border-bottom: 3px solid #ddd;
        }
        .logo-section img {
            max-width: 225px;
            width: 100%;
            height: auto;
            flex-shrink: 0;
            display: block;
        }
        .title-section {
            flex: 1;
        }
        .title-section h1 {
            margin: 0;
            text-align: center;
            font-size: clamp(20px, 5vw, 32px);
            color: #333;
        }
        .safety-link {
            text-align: center;
            margin-bottom: 20px;
            padding: 12px;
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            border-radius: 4px;
        }
        .safety-link a {
            color: #e65100;
            font-weight: 600;
            text-decoration: none;
            font-size: 14px;
        }
        .safety-link a:hover {
            text-decoration: underline;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        select, input[type="number"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        .slider-value {
            font-weight: 600;
            min-width: 30px;
            text-align: center;
            color: #667eea;
        }
        .packs-section {
            margin-bottom: 30px;
        }
        .packs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .packs-header h2 {
            color: #333;
            font-size: 18px;
        }
        button {
            padding: 10px 20px;
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #5568d3;
        }
        .packs-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .pack-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .pack-input input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
        }
        .pack-input label {
            font-size: 12px;
            color: #666;
        }
        .remove-btn {
            padding: 6px 12px;
            background-color: #e74c3c;
            font-size: 12px;
            margin-top: auto;
        }
        .remove-btn:hover {
            background-color: #c0392b;
        }
        .results-section {
            margin-top: 30px;
        }
        .results-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
        }
        .charging-groups {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .group-card {
            background-color: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            border-left: 6px solid;
        }
        .group-card.color-0 {
            border-left-color: #FF6B6B;
            background-color: #FFE5E5;
        }
        .group-card.color-1 {
            border-left-color: #4ECDC4;
            background-color: #E5F9F7;
        }
        .group-card.color-2 {
            border-left-color: #FFD93D;
            background-color: #FFFAE5;
        }
        .group-card.color-3 {
            border-left-color: #6BCB77;
            background-color: #E5F9ED;
        }
        .group-card.color-4 {
            border-left-color: #A78BFA;
            background-color: #F3E8FF;
        }
        .group-card.color-5 {
            border-left-color: #FB7185;
            background-color: #FFE5E9;
        }
        .group-card.color-6 {
            border-left-color: #06B6D4;
            background-color: #E5F9FC;
        }
        .group-card.color-7 {
            border-left-color: #F59E0B;
            background-color: #FEF3E5;
        }
        .group-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .group-packs {
            list-style: none;
        }
        .group-packs li {
            padding: 8px;
            background-color: white;
            margin-bottom: 6px;
            border-radius: 4px;
            border-left: 4px solid #667eea;
            padding-left: 12px;
            font-size: 14px;
        }
        .pack-status {
            font-size: 12px;
            margin-top: 3px;
            font-weight: 500;
        }
        .status-safe {
            color: #27ae60;
        }
        .status-warning {
            color: #f39c12;
        }
        .status-danger {
            color: #e74c3c;
        }
        .status-full {
            color: #2196F3;
        }
        .status-storage {
            color: #757575;
        }
        .group-stats {
            margin-top: 12px;
            font-size: 12px;
            color: #666;
            padding-top: 12px;
            border-top: 1px solid #ddd;
        }
        .empty-message {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 16px;
        }
        .info-box, .warning-box, .danger-box, .gray-box {
            padding: 12px;
            margin-bottom: 15px;
            border-left: 4px solid;
            border-radius: 4px;
            font-size: 14px;
        }
        .info-box {
            background-color: #e3f2fd;
            border-color: #2196F3;
            color: #1565c0;
        }
        .warning-box {
            background-color: #fff3e0;
            border-color: #ff9800;
            color: #e65100;
        }
        .danger-box {
            background-color: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        .gray-box {
            background-color: #f5f5f5;
            border-color: #9e9e9e;
            color: #616161;
        }
        .alerts-section {
            margin-top: 30px;
        }
        .alerts-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .alert-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .shop-section {
            margin-top: 40px;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }
        .shop-section h2 {
            color: white;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .shop-section h3 {
            color: white;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }
        .shop-section p {
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.6;
        }
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        .shop-card {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .shop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .shop-card h4 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .shop-card p {
            color: #666;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .shop-card a {
            display: inline-block;
            background-color: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        .shop-card a:hover {
            background-color: #5568d3;
        }
        .safety-resources {
            margin-top: 40px;
            padding: 25px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .safety-resources h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .safety-resources p {
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 14px;
        }
        .resource-link {
            display: block;
            margin-bottom: 15px;
            padding: 12px;
            background-color: white;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            text-decoration: none;
            transition: transform 0.2s;
        }
        .resource-link:hover {
            transform: translateX(5px);
        }
        .resource-link strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .resource-link span {
            color: #666;
            font-size: 12px;
        }
        .note-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            border-radius: 4px;
        }
        .note-section h3 {
            color: #e65100;
            margin-bottom: 12px;
            font-size: 16px;
        }
        .note-section p {
            color: #e65100;
            line-height: 1.6;
            font-size: 14px;
        }
        .disclaimer-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            border-radius: 4px;
        }
        .disclaimer-section h3 {
            color: #c62828;
            margin-bottom: 12px;
            font-size: 16px;
        }
        .disclaimer-section p {
            color: #c62828;
            line-height: 1.6;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .shop-section {
                padding: 15px;
                margin-top: 30px;
            }
            .shop-section h2 {
                font-size: 18px;
            }
            .shop-section h3 {
                font-size: 15px;
            }
            .shop-grid {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 15px;
            }
            .safety-resources {
                padding: 15px;
            }
            .note-section, .disclaimer-section {
                padding: 15px;
            }
            .logo-section {
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 15px;
                padding-bottom: 15px;
                border-bottom: 3px solid #ddd;
                margin-bottom: 15px;
            }
            .logo-section img {
                max-width: 120px;
            }
            .title-section {
                width: 100%;
            }
            .title-section h1 {
                text-align: center;
                margin: 0;
            }
            .info-box {
                margin-top: 0;
                margin-bottom: 20px;
            }
            .settings-grid {
                grid-template-columns: 1fr;
                padding: 15px;
            }
            .packs-input-grid {
                grid-template-columns: 1fr;
            }
            .charging-groups {
                grid-template-columns: 1fr;
            }
            .legend {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-section">
            <a href="index.html" style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; text-decoration: none;">
                <img src="https://raw.githubusercontent.com/blueback22/bluebackfpv-tools/main/BluebackFPV_logo.png" alt="BluebackFPV Logo" style="display: block; max-width: 225px; width: 100%; height: auto; flex-shrink: 0;">
                <div class="title-section" style="width: 100%;">
                    <h1>‚ö° LiPo Pack Charging Groups</h1>
                </div>
            </a>
        </div>

        <div class="safety-link">
            <strong>New to parallel charging?</strong> <a href="#safety-resources">Learn how to parallel charge safely</a>
        </div>

        <div class="info-box">
            <strong>How it works:</strong> Enter your cell count, add pack voltages, set your parallel charging board capacity, and get optimal charging groups based on voltage compatibility.
        </div>

        <div class="settings-grid">
            <div class="setting-group">
                <label for="cellCount">Cell Count (S)</label>
                <select id="cellCount">
                    <option value="2" selected>2S</option>
                    <option value="3">3S</option>
                    <option value="4">4S</option>
                    <option value="5">5S</option>
                    <option value="6">6S</option>
                    <option value="8">8S</option>
                </select>
            </div>

            <div class="setting-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="isHV" onchange="updateMaxVoltage()">
                    <label for="isHV">High Voltage (LiHV) - 4.35V/cell max</label>
                </div>
            </div>

            <div class="setting-group">
                <label for="maxPacks">Max Packs to Charge Together</label>
                <div class="slider-container">
                    <input type="range" id="maxPacks" min="2" max="10" value="4">
                    <span class="slider-value" id="maxPacksValue">4</span>
                </div>
            </div>

            <div class="setting-group">
                <label id="maxDeltaLabel">Max Allowed Voltage Delta: 0.2V</label>
                <p style="font-size: 12px; color: #999; margin-top: 5px;">Calculated as 0.1V √ó cell count</p>
            </div>
        </div>

        <div class="packs-section">
            <div class="packs-header">
                <h2>Battery Packs</h2>
                <button onclick="addPackInput()">+ Add Pack</button>
            </div>

            <div id="packsContainer" class="packs-input-grid"></div>

            <div id="errorMessage"></div>
        </div>

        <button onclick="calculateGroups()" style="width: 100%; padding: 15px; font-size: 16px; margin-bottom: 20px;">Calculate Charging Groups</button>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #d4edda;"></div>
                <span>Safe to Charge</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e2e3e5;"></div>
                <span>At Storage Voltage</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #cfe2ff;"></div>
                <span>Full - Do Not Charge</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #fff3cd;"></div>
                <span>Over-discharged but Safe</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f8d7da;"></div>
                <span>Damaged - Do Not Charge</span>
            </div>
        </div>

        <div class="alerts-section" id="alertsSection" style="display: none;">
            <h3>‚ö†Ô∏è Battery Status Alerts</h3>
            <div class="alert-list" id="alertsList"></div>
        </div>

        <div class="results-section">
            <h2>Recommended Charging Groups</h2>
            <div id="resultsContainer" class="empty-message">
                Add packs and click "Calculate Charging Groups" to see results
            </div>
        </div>

        <div class="safety-resources" id="safety-resources">
            <h2>Learn About LiPo & Parallel Charging Safety</h2>
            <p>Before parallel charging, make sure you understand the risks and proper procedures:</p>
            
            <a href="https://oscarliang.com/parallel-charging-multiple-lipo/" target="_blank" class="resource-link">
                <strong>Oscar Liang: "Mastering LiPo Parallel Charging: The Safety Guide for FPV Drone Pilots"</strong>
                <span>Comprehensive guide to parallel charging safety</span>
            </a>

            <a href="https://www.youtube.com/watch?v=mRlsaD5tf_8" target="_blank" class="resource-link">
                <strong>Joshua Bardwell: "How To Parallel Charge LiPo Batteries Without Burning Down Your House"</strong>
                <span>Video guide to safe parallel charging practices</span>
            </a>

            <a href="https://www.youtube.com/watch?v=n3urBpFIBgY" target="_blank" class="resource-link">
                <strong>Joshua Bardwell: "How to Keep LiPos from Burning Down Your House"</strong>
                <span>Essential LiPo safety and charging guidelines</span>
            </a>

            <div style="margin-top: 25px; padding: 15px; background-color: white; border-radius: 6px; border-left: 4px solid #667eea; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <img src="https://m.media-amazon.com/images/I/41IVl3gUP-L.jpg" alt="LiPo Cell Checker" style="width: 120px; height: auto; border-radius: 4px;">
                <div style="flex: 1; min-width: 200px;">
                    <p style="margin-bottom: 10px; font-weight: 600; color: #333;">Need a cell checker to measure your pack voltages?</p>
                    <a href="https://amzn.to/3YO7wSh" target="_blank" style="display: inline-block; background-color: #667eea; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 600; transition: background-color 0.3s;">
                        Check out this LiPo Cell Checker on Amazon
                    </a>
                    <p style="margin-top: 10px; font-size: 12px; color: #999;">Affiliate link - supports BluebackFPV at no cost to you</p>
                </div>
            </div>

            <p style="margin-top: 20px; font-weight: 600; color: #c62828;">Remember: No amount of convenience is worth a fire or injury. When in doubt, charge batteries individually.</p>
        </div>

        <div class="note-section">
            <h3>Voltage Tolerance Note</h3>
            <p>The 0.1v per cell default in this tool is commonly used in the FPV community, but some pilots prefer tighter tolerances (0.05v or less) for added safety margin. Others are comfortable with slightly larger differences. This tool uses 0.1v per cell as a balance between safety and practicality, but you should use your own judgment based on your comfort level and risk assessment.</p>
        </div>

        <div class="disclaimer-section">
            <h3>DISCLAIMER</h3>
            <p>This tool is provided as-is for informational purposes. Parallel charging LiPo batteries carries inherent risks. Always follow proper safety protocols, use appropriate equipment, and charge in a safe location. You are responsible for your own safety practices. This tool does not guarantee safe charging and should be used alongside proper LiPo safety knowledge and equipment. I am not responsible if you burn your house down.</p>
        </div>

        <div class="footer" style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
            ¬© 2025 BluebackFPV. All rights reserved.
        </div>
    </div>

    <script>
        let packCount = 3;
        let cellCount = 2;
        let isHV = false;

        function updateMaxVoltage() {
            isHV = document.getElementById('isHV').checked;
        }

        function addPackInput() {
            packCount++;
            renderPackInputs();
        }

        function removePackInput(index) {
            const container = document.getElementById('packsContainer');
            const inputs = container.querySelectorAll('.pack-input');
            if (inputs.length > 1) {
                inputs[index].remove();
            }
        }

        function renderPackInputs() {
            const container = document.getElementById('packsContainer');
            const inputs = container.querySelectorAll('.pack-input');
            
            for (let i = inputs.length; i < packCount; i++) {
                const packDiv = document.createElement('div');
                packDiv.className = 'pack-input';
                const packNum = i + 1;
                packDiv.innerHTML = '<label>Pack ' + packNum + ' Voltage (V)</label><input type="number" class="pack-voltage" step="0.001" placeholder="0.000"><button class="remove-btn" onclick="removePackInput(' + i + ')">Remove</button>';
                container.appendChild(packDiv);
            }
        }

        function getPackVoltages() {
            const inputs = document.querySelectorAll('.pack-voltage');
            const packs = [];
            inputs.forEach((input, index) => {
                const voltage = parseFloat(input.value);
                if (!isNaN(voltage) && voltage > 0) {
                    packs.push({ id: index + 1, voltage: voltage });
                }
            });
            return packs;
        }

        function getVoltageStatus(voltagePerCell) {
            const fullVoltage = isHV ? 4.35 : 4.2;
            const storageVoltage = 3.8;
            
            if (voltagePerCell > 4.3 && !isHV) {
                return { status: 'danger', label: 'üî• OVERCHARGED - Dangerous' };
            } else if (voltagePerCell > fullVoltage) {
                return { status: 'danger', label: 'üî• OVERCHARGED - Dangerous' };
            } else if (voltagePerCell >= fullVoltage - 0.05) {
                return { status: 'full', label: 'üîã FULL - Do not charge' };
            } else if (voltagePerCell >= storageVoltage) {
                return { status: 'safe', label: '‚úì Safe to Charge' };
            } else if (voltagePerCell >= 3.3) {
                return { status: 'safe', label: '‚úì Safe to Charge' };
            } else if (voltagePerCell >= 3.0) {
                return { status: 'warning', label: '‚ö†Ô∏è Over-discharged but safe' };
            } else {
                return { status: 'danger', label: 'üõë Damaged - Do not charge' };
            }
        }

        function calculateGroups() {
            const errorDiv = document.getElementById('errorMessage');
            const alertsDiv = document.getElementById('alertsSection');
            const alertsList = document.getElementById('alertsList');
            
            errorDiv.innerHTML = '';
            alertsDiv.style.display = 'none';
            alertsList.innerHTML = '';

            cellCount = parseInt(document.getElementById('cellCount').value);
            const maxDelta = cellCount * 0.1;
            const maxPacksPerGroup = parseInt(document.getElementById('maxPacks').value);
            const packs = getPackVoltages();

            if (packs.length === 0) {
                errorDiv.innerHTML = '<div class="danger-box">Please add at least one pack with a voltage.</div>';
                return;
            }

            const packsWithStatus = packs.map(pack => {
                const voltagePerCell = pack.voltage / cellCount;
                const status = getVoltageStatus(voltagePerCell);
                return { ...pack, voltagePerCell, ...status };
            });

            const alerts = packsWithStatus.filter(p => p.status !== 'safe');
            if (alerts.length > 0) {
                alertsDiv.style.display = 'block';
                alerts.forEach(pack => {
                    const boxClass = pack.status === 'danger' ? 'danger-box' : 'warning-box';
                    alertsList.innerHTML += `
                        <div class="${boxClass}">
                            <strong>Pack ${pack.id}:</strong> ${pack.voltagePerCell.toFixed(3)}V/cell - ${pack.label}
                        </div>
                    `;
                });
            }

            packsWithStatus.sort((a, b) => b.voltage - a.voltage);

            const groups = [];
            const usedPacks = new Set();

            for (const pack of packsWithStatus) {
                if (usedPacks.has(pack.id)) continue;

                let addedToGroup = false;
                for (const group of groups) {
                    if (group.packs.length < maxPacksPerGroup) {
                        const minVoltage = Math.min(...group.packs.map(p => p.voltage));
                        const maxVoltage = Math.max(...group.packs.map(p => p.voltage));
                        
                        const newMin = Math.min(minVoltage, pack.voltage);
                        const newMax = Math.max(maxVoltage, pack.voltage);
                        
                        if (newMax - newMin <= maxDelta) {
                            group.packs.push(pack);
                            usedPacks.add(pack.id);
                            addedToGroup = true;
                            break;
                        }
                    }
                }

                if (!addedToGroup) {
                    groups.push({ packs: [pack] });
                    usedPacks.add(pack.id);
                }
            }

            displayResults(groups, maxDelta);
        }

        function displayResults(groups, maxDelta) {
            const container = document.getElementById('resultsContainer');
            
            if (groups.length === 0) {
                container.innerHTML = '<div class="empty-message">No packs to display</div>';
                return;
            }

            let html = '<div class="charging-groups">';

            groups.forEach((group, index) => {
                const minVoltage = Math.min(...group.packs.map(p => p.voltage));
                const maxVoltage = Math.max(...group.packs.map(p => p.voltage));
                const deltaInGroup = (maxVoltage - minVoltage).toFixed(3);
                
                const hasProblems = group.packs.some(p => p.status === 'danger');
                let colorClass;
                
                if (hasProblems) {
                    colorClass = 'color-0';
                } else {
                    const nonProblemIndex = groups.filter((g, i) => i < index && !g.packs.some(p => p.status === 'danger')).length;
                    colorClass = `color-${(nonProblemIndex % 7) + 1}`;
                }

                html += `
                    <div class="group-card ${colorClass}">
                        <h3>Charging Group ${index + 1}</h3>
                        <ul class="group-packs">
                            ${group.packs.map(pack => {
                                const statusClass = pack.status === 'danger' ? 'status-danger' : 
                                                   pack.status === 'warning' ? 'status-warning' : 
                                                   pack.status === 'full' ? 'status-full' :
                                                   pack.status === 'storage' ? 'status-storage' :
                                                   'status-safe';
                                return `
                                    <li>
                                        Pack ${pack.id}: <strong>${pack.voltage.toFixed(3)}V</strong>
                                        <div class="pack-status ${statusClass}">${pack.label}</div>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                        <div class="group-stats">
                            <div>Count: ${group.packs.length} pack(s)</div>
                            <div>Min: ${minVoltage.toFixed(3)}V (${(minVoltage / cellCount).toFixed(3)}V/cell)</div>
                            <div>Max: ${maxVoltage.toFixed(3)}V (${(maxVoltage / cellCount).toFixed(3)}V/cell)</div>
                            <div>Delta: ${deltaInGroup}V (Max: ${maxDelta.toFixed(1)}V)</div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        window.addEventListener('DOMContentLoaded', () => {
            cellCount = 2;
            document.getElementById('maxDeltaLabel').textContent = `Max Allowed Voltage Delta: 0.2V`;
            renderPackInputs();
        });

        document.getElementById('cellCount').addEventListener('change', () => {
            cellCount = parseInt(document.getElementById('cellCount').value);
            const maxDelta = (cellCount * 0.1).toFixed(1);
            document.getElementById('maxDeltaLabel').textContent = `Max Allowed Voltage Delta: ${maxDelta}V`;
        });

        document.getElementById('maxPacks').addEventListener('input', (e) => {
            document.getElementById('maxPacksValue').textContent = e.target.value;
        });
    </script>
</body>
</html>
